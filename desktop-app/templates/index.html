<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sentinel AI Command Center - Advanced Mission Control System">
    <title>Sentinel Command Center</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700;800&family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Core Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Sentinel Application Styles (Order is important) -->
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="/static/css/custom-theme.css" rel="stylesheet">
    <link href="/static/css/service-status.css" rel="stylesheet">

    <!-- The NEW Dashboard Theme (Loaded LAST to override styles) -->
    <link href="/static/css/sentinel-dash.css" rel="stylesheet">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body x-data="sentinelApp()" :data-bs-theme="settings.theme">

    <div id="loading-screen" class="loading-screen">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status"><span class="visually-hidden">Loading...</span></div>
            <h5 class="text-light">Initializing Sentinel Command Center...</h5>
        </div>
    </div>

    <div class="dash">

        <!-- HEADER -->
        <header class="header">
            <h1 class="header__heading"><a href="#" rel="noreferrer noopener">SENTINEL</a></h1>
            <div class="header__search">
                <!-- Search functionality can be added here later -->
            </div>
            <div class="header__options">
                <div class="sidebar-status me-5">
                    <div class="status-indicator" :class="serviceStatus.overall_status">
                        <div class="status-dot"></div>
                        <span class="status-text small ms-2" x-text="serviceStatus.overall_status.toUpperCase()">OPERATIONAL</span>
                    </div>
                </div>
                <button class="header__pro" @click="refreshAllData()">
                    <i class="bi bi-arrow-clockwise"></i> REFRESH
                </button>
            </div>
        </header>
      
        <!-- BODY -->
        <div class="body">
      
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'dashboard' }" @click="setActiveTab('dashboard')" title="Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                </div>
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'missions' }" @click="setActiveTab('missions')" title="Missions">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </div>
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'observability' }" @click="setActiveTab('observability')" title="Observability">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                </div>
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'settings' }" @click="setActiveTab('settings')" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </div>
            </div>
      
            <!-- MAIN -->
            <main class="main">
                <!-- DASHBOARD TAB -->
                <div x-show="activeTab === 'dashboard'" class="fade-in d-flex flex-column" style="width: 100%;">
                    <div class="main__col-1">
                        <div>
                            <h2 class="main__heading"><span style="background: linear-gradient(to bottom, hsl(247, 88%, 70%), hsl(282, 82%, 51%)); box-shadow: 0 2px 12px hsla(247, 88%, 70%, .3)"><i class="bi bi-shield-check text-white"></i></span> Sentinel OS</h2>
                            <p class="main__desc">The Sentient Supercharged Phoenix System. Ready for mission deployment.</p>
                            <p class="main__sub"><span>System Status:</span> <span class="text-success fw-bold" x-text="serviceStatus.overall_status.toUpperCase()">OPERATIONAL</span></p>
                        </div>
                        
                        <div class="main__list-heading-wrap mt-5 mb-4">
                            <h2 class="main__list-heading ss-heading">Live Mission Feed</h2>
                        </div>
                        <div class="terminal" style="height: 250px; color: var(--sentinel-white-secondary); background: var(--sentinel-black-primary);" x-html="liveFeed.replace(/\n/g, '<br>')"></div>
                    </div>
            
                    <div class="main__col-2">
                        <div class="main__cards-container">
                            <div class="main__cards-container-heading-wrap">
                                <h2 class="main__cards-container-heading ss-heading">Deploy New Mission</h2>
                            </div>
                            <div class="p-3">
                                <input type="text" class="form-control mb-3" x-model="newMission.title" placeholder="Mission Title (Optional)">
                                <textarea class="form-control" rows="4" x-model="newMission.objective" placeholder="Describe the mission objective in detail..."></textarea>
                                <button class="btn btn-primary w-100 mt-3 header__pro" @click="deployMission()" :disabled="deploying">
                                    <i class="bi bi-rocket-takeoff me-2"></i>
                                    <span x-text="deploying ? 'DEPLOYING...' : 'DEPLOY MISSION'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MISSIONS TAB -->
                <div x-show="activeTab === 'missions'" class="fade-in" style="width: 100%;">
                    <div class="card" style="background: hsl(270, 50%, 11%); border: 1px solid var(--sentinel-black-accent);">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 ss-heading">Mission History</h5>
                            <a href="#" class="ss-show" @click.prevent="loadMissions()">Refresh List</a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr><th>ID</th><th>Title</th><th>Agent</th><th>Status</th><th>Created</th><th>Actions</th></tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="mission in missions" :key="mission.id">
                                            <tr>
                                                <td x-text="mission.mission_id_str.split('_')[1]"></td>
                                                <td x-text="mission.title"></td>
                                                <td x-text="mission.agent_type"></td>
                                                <td><span class="badge" :class="'bg-' + getStatusClass(mission.status)" x-text="mission.status"></span></td>
                                                <td x-text="formatDate(mission.created_at)"></td>
                                                <td><button class="btn btn-sm btn-outline-primary" @click="viewMission(mission)"><i class="bi bi-eye"></i> View</button></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- OBSERVABILITY & SETTINGS TABS -->
                <div x-show="activeTab === 'observability'" class="fade-in text-center" style="width: 100%;">
                    <h2 class="main__heading">Observability</h2>
                    <p class="main__desc">Weave and WandB integration dashboards will be displayed here.</p>
                </div>
                 <div x-show="activeTab === 'settings'" class="fade-in text-center" style="width: 100%;">
                    <h2 class="main__heading">Settings</h2>
                    <p class="main__desc">System configuration and theme settings will be available here.</p>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal fade" id="missionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title ss-heading"><i class="bi bi-robot me-2"></i> Mission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" x-show="selectedMission">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card" style="border: 1px solid var(--sentinel-black-accent);">
                                <div class="card-header"><h6 class="card-title mb-0">Overview</h6></div>
                                <div class="card-body">
                                    <p><strong>Mission ID:</strong> <span x-text="selectedMission.mission_id_str || selectedMission.id"></span></p>
                                    <p><strong>Title:</strong> <span x-text="selectedMission.title"></span></p>
                                    <p><strong>Agent Type:</strong> <span class="badge bg-primary" x-text="selectedMission.agent_type"></span></p>
                                    <p><strong>Status:</strong> <span class="badge" :class="'bg-' + getStatusClass(selectedMission.status)" x-text="selectedMission.status"></span></p>
                                    <p><strong>Created:</strong> <span x-text="formatDate(selectedMission.created_at)"></span></p>
                                    <p x-show="selectedMission.execution_time"><strong>Execution Time:</strong> <span x-text="selectedMission.execution_time + ' seconds'"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="card" style="border: 1px solid var(--sentinel-black-accent);">
                                <div class="card-header"><h6 class="card-title mb-0">Prompt</h6></div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;" x-text="selectedMission.prompt"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="border: 1px solid var(--sentinel-black-accent);">
                        <div class="card-header"><h6 class="card-title mb-0">Result & Live Feed</h6></div>
                        <div class="card-body">
                            <div x-show="selectedMission.result"><h6 class="mb-2 ss-heading">Final Result:</h6><div class="p-3 rounded mb-3 terminal" style="background: var(--sentinel-black-primary);"><pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;" x-text="selectedMission.result"></pre></div></div>
                            <div x-show="selectedMission.updates"><h6 class="mb-2 ss-heading">Updates:</h6><div class="p-3 rounded terminal" style="background: var(--sentinel-black-primary); max-height: 250px;"><template x-for="update in selectedMission.updates"><p class="mb-1 small"><span x-text="formatTime(update.timestamp) + ': '"></span><span x-text="update.message"></span></p></template></div></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary header__pro" @click="refreshMissionDetails()"><i class="bi bi-arrow-clockwise me-2"></i> Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"><div id="toast-container"></div></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sentinelApp() {
            return {
                activeTab: 'dashboard',
                deploying: false,
                liveFeed: 'System initialized. Ready for missions...',
                newMission: { title: '', objective: '' },
                missions: [],
                selectedMission: null,
                settings: { refreshInterval: 10000, theme: 'dark' },
                serviceStatus: { overall_status: 'loading', services: {}, system: { memory_usage: 0, cpu_usage: 0, disk_usage: 0, memory_available: 0, disk_free: 0 } },
                missionCheckInterval: null,

                init() {
                    this.loadMissions();
                    this.updateServiceStatus();
                    this.startPolling();
                    this.hideLoadingScreen();
                },
                
                setActiveTab(tab) { this.activeTab = tab; },

                async deployMission() {
                    if (!this.newMission.objective.trim()) { this.showToast('Please enter a mission objective.', 'warning'); return; }
                    this.deploying = true;
                    this.liveFeed = 'Initializing mission deployment...';
                    try {
                        const response = await fetch('/advanced-mission', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: this.newMission.objective, title: this.newMission.title || this.newMission.objective.substring(0, 50), agent_type: 'developer' })
                        });
                        const data = await response.json();
                        if (!response.ok) { throw new Error(data.detail || 'Failed to deploy mission'); }
                        
                        this.liveFeed = `Mission ${data.mission_id} deployed successfully!\nStatus: PLANNING...`;
                        this.showToast('Mission deployed successfully!', 'success');
                        this.newMission = { title: '', objective: '' };
                        this.loadMissions();

                        // Start polling for this specific mission's status
                        this.pollMissionStatus(data.mission_id);

                    } catch (error) {
                        this.liveFeed = `Mission deployment failed: ${error.message}`;
                        this.showToast(error.message, 'danger');
                    } finally {
                        this.deploying = false;
                    }
                },

                pollMissionStatus(missionId) {
                    if (this.missionCheckInterval) clearInterval(this.missionCheckInterval);

                    this.missionCheckInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`/mission/${missionId}`);
                            if (!response.ok) return;
                            const data = await response.json();
                            
                            let feedContent = `Mission ${missionId} Status: ${data.status}\n\n`;
                            data.updates.forEach(update => {
                                feedContent += `${this.formatTime(update.timestamp)}: ${update.message}\n`;
                            });
                            this.liveFeed = feedContent;

                            if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                                clearInterval(this.missionCheckInterval);
                                this.loadMissions(); // Refresh the main list
                            }
                        } catch (error) {
                            console.error('Error polling mission status:', error);
                            clearInterval(this.missionCheckInterval);
                        }
                    }, 2000);
                },

                async loadMissions() {
                    try {
                        const response = await fetch('/missions');
                        if (response.ok) { this.missions = await response.json(); }
                    } catch (error) { console.error('Error loading missions:', error); }
                },
                
                async updateServiceStatus() {
                    try {
                        const response = await fetch('/service-status');
                        if (response.ok) { this.serviceStatus = await response.json(); }
                    } catch (error) {
                        this.serviceStatus.overall_status = 'error';
                        console.error('Error updating service status:', error);
                    }
                },

                formatDate(dateString) { return new Date(dateString).toLocaleString(); },
                formatTime(dateString) { return new Date(dateString).toLocaleTimeString(); },

                getStatusClass(status) {
                    const s = status ? status.toLowerCase() : '';
                    if (s === 'completed') return 'success';
                    if (s === 'executing' || s === 'planning') return 'info';
                    if (s === 'failed') return 'danger';
                    if (s === 'pending') return 'warning';
                    return 'secondary';
                },

                async viewMission(mission) {
                    try {
                        const missionId = mission.mission_id_str || mission.id;
                        const response = await fetch(`/mission/${missionId}`);
                        if (response.ok) {
                            this.selectedMission = await response.json();
                            const modal = new bootstrap.Modal(document.getElementById('missionDetailsModal'));
                            modal.show();
                        } else {
                           this.showToast('Failed to fetch mission details.', 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching mission details:', error);
                        this.showToast('Error fetching mission details.', 'error');
                    }
                },
                
                async refreshMissionDetails() {
                    if (this.selectedMission) {
                        await this.viewMission({ mission_id_str: this.selectedMission.mission_id });
                        this.showToast('Mission details refreshed!', 'success');
                    }
                },

                startPolling() { 
                    setInterval(() => { 
                        this.loadMissions();
                        this.updateServiceStatus();
                    }, this.settings.refreshInterval); 
                },

                showToast(message, type = 'info') {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    const bgClass = type === 'danger' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : type === 'success' ? 'bg-success' : 'bg-info';
                    toast.className = `toast show align-items-center text-white ${bgClass} border-0`;
                    toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
                    toastContainer.appendChild(toast);
                    setTimeout(() => { toast.remove(); }, 5000);
                },

                hideLoadingScreen() {
                    setTimeout(() => {
                        const screen = document.getElementById('loading-screen');
                        if(screen) screen.classList.add('hidden');
                    }, 500);
                },
                
                refreshAllData() { 
                    this.loadMissions();
                    this.updateServiceStatus();
                    this.showToast('All data refreshed', 'success'); 
                },
            }
        }
    </script>
</body>
</html>