<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700;800&family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/sentinel-dash.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body x-data="sentinelApp()">
    <div class="dash">
        <!-- HEADER -->
        <header class="header">
            <h1 class="header__heading"><a href="#" rel="noreferrer noopener">SENTINEL</a></h1>
            <div class="header__options">
                <div class="sidebar-status me-3">
                    <div class="status-indicator">
                        <div class="status-dot" :class="serviceStatus.overall_status === 'healthy' ? 'bg-success' : 'bg-danger'"></div>
                        <span class="status-text small ms-2" x-text="serviceStatus.overall_status.toUpperCase()">OPERATIONAL</span>
                    </div>
                </div>
                <div class="sidebar-status me-3">
                    <div class="status-indicator">
                        <div class="status-dot bg-success"></div>
                        <span class="status-text small ms-2">SERVER 8001</span>
                    </div>
                </div>
                <div class="sidebar-status me-5">
                    <div class="status-indicator">
                        <div class="status-dot bg-success"></div>
                        <span class="status-text small ms-2">SERVER 8002</span>
                    </div>
                </div>
                <button class="header__pro" @click="refreshAllData()"><i class="bi bi-arrow-clockwise"></i> REFRESH</button>
            </div>
        </header>
      
        <!-- BODY -->
        <div class="body">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'dashboard' }" @click="setActiveTab('dashboard')" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></div>
                <div class="sidebar__icon" :class="{ 'active': activeTab === 'missions' }" @click="setActiveTab('missions')" title="Missions"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
            </div>
      
            <!-- MAIN CONTENT AREA -->
            <main class="main">
                <!-- DASHBOARD TAB (STRATEGIC COMMAND CENTER) -->
                <div x-show="activeTab === 'dashboard'" class="fade-in" style="width: 100%;">
                    <div class="row g-4">
                        <!-- Active Missions -->
                        <div class="col-lg-4">
                            <div class="main__cards-container h-100">
                                <h2 class="ss-heading">Active Missions</h2>
                                <div style="height: 350px; overflow-y: auto;">
                                    <template x-for="mission in activeMissions" :key="mission.id">
                                        <div class="card mb-2" style="background: hsl(270, 50%, 8%);">
                                            <div class="card-body p-3">
                                                <h6 class="mb-1" x-text="mission.title"></h6>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted" x-text="mission.mission_id_str"></small>
                                                    <span class="badge" :class="getStatusClass(mission.status)" x-text="mission.status"></span>
                            </div>
                        </div>
                                        </div>
                                    </template>
                                    <div x-show="activeMissions.length === 0" class="text-center text-muted pt-5"><i class="bi bi-inbox fs-1"></i><p>No active missions.</p></div>
                                </div>
                                </div>
                            </div>
                            
                        <!-- Enhanced Observability Hub -->
                        <div class="col-lg-8">
                            <div class="main__cards-container h-100">
                                <h2 class="ss-heading">Observability Hub</h2>
                                <div class="btn-group w-100 mb-3" role="group">
                                    <button class="btn btn-sm" :class="observabilityView === 'overview' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="observabilityView = 'overview'">Overview</button>
                                    <button class="btn btn-sm" :class="observabilityView === 'weave' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="observabilityView = 'weave'">Weave</button>
                                    <button class="btn btn-sm" :class="observabilityView === 'wandb' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="observabilityView = 'wandb'">WandB</button>
                                    <button class="btn btn-sm" :class="observabilityView === 'sentry' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="observabilityView = 'sentry'">Sentry</button>
                                </div>
                                <div style="height: 350px; overflow-y: auto;">
                                    <!-- Overview -->
                                    <div x-show="observabilityView === 'overview'" class="row g-3">
                                        <div class="col-4 text-center">
                                            <h6 class="ss-heading">Weave</h6>
                                            <p class="mb-0" x-text="observability.weave.active_traces + ' Traces'"></p>
                                            <small class="text-muted" x-text="observability.weave.status"></small>
                                            <div class="mt-2">
                                                <small class="text-success" x-text="observability.weave.success_rate + '% Success'"></small>
                                    </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <h6 class="ss-heading">WandB</h6>
                                            <p class="mb-0" x-text="observability.wandb.active_runs + ' Runs'"></p>
                                            <small class="text-muted" x-text="observability.wandb.status"></small>
                                            <div class="mt-2">
                                                <small class="text-info" x-text="observability.wandb.best_accuracy + '% Best'"></small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <h6 class="ss-heading">Sentry</h6>
                                            <p class="mb-0" x-text="observability.sentry.active_issues + ' Issues'"></p>
                                            <small class="text-muted" x-text="observability.sentry.status"></small>
                                            <div class="mt-2">
                                                <small class="text-warning" x-text="observability.sentry.error_rate_percent + '% Error Rate'"></small>
                                            </div>
                            </div>
                        </div>
                        
                                    <!-- Weave Details -->
                                    <div x-show="observabilityView === 'weave'" class="p-3">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-primary mb-2">Success Rate</h6>
                                                        <h4 x-text="observability.weave.success_rate + '%'"></h4>
                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-info mb-2">Avg Response</h6>
                                                        <h4 x-text="observability.weave.avg_response_ms + 'ms'"></h4>
                                            </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6 class="text-light mb-2">Status: <span x-text="observability.weave.status" :class="observability.weave.status === 'ACTIVE' ? 'text-success' : 'text-warning'"></span></h6>
                            </div>
                        </div>
                        
                                    <!-- WandB Details -->
                                    <div x-show="observabilityView === 'wandb'" class="p-3">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-success mb-2">Best Accuracy</h6>
                                                        <h4 x-text="observability.wandb.best_accuracy + '%'"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-warning mb-2">Avg Loss</h6>
                                                        <h4 x-text="observability.wandb.avg_loss"></h4>
                                            </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6 class="text-light mb-2">Status: <span x-text="observability.wandb.status" :class="observability.wandb.status === 'ACTIVE' ? 'text-success' : 'text-warning'"></span></h6>
                            </div>
                        </div>
                        
                                    <!-- Sentry Details -->
                                    <div x-show="observabilityView === 'sentry'" class="p-3">
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-danger mb-2">Error Rate</h6>
                                                        <h4 x-text="observability.sentry.error_rate_percent + '%'"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card bg-dark border-secondary">
                                                    <div class="card-body p-3 text-center">
                                                        <h6 class="text-success mb-2">Uptime</h6>
                                                        <h4 x-text="observability.sentry.uptime_percent + '%'"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6 class="text-light mb-2">Status: <span x-text="observability.sentry.status" :class="observability.sentry.status === 'ACTIVE' ? 'text-success' : 'text-warning'"></span></h6>
                                </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Event Feed -->
                        <div class="col-lg-12">
                            <div class="main__cards-container">
                                <h2 class="ss-heading">Live Event Feed</h2>
                                <div class="btn-group w-100 mb-3" role="group">
                                    <button class="btn btn-sm" :class="liveFeedView === 'overview' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="liveFeedView = 'overview'">Overview</button>
                                    <button class="btn btn-sm" :class="liveFeedView === 'server_8001' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="liveFeedView = 'server_8001'">Server 8001</button>
                                    <button class="btn btn-sm" :class="liveFeedView === 'server_8002' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="liveFeedView = 'server_8002'">Server 8002</button>
                                    <button class="btn btn-sm" :class="liveFeedView === 'system' ? 'btn-primary header__pro' : 'btn-outline-secondary'" @click="liveFeedView = 'system'">System</button>

                                </div>
                                
                                <!-- Overview Tab -->
                                <div x-show="liveFeedView === 'overview'" class="terminal" style="height: 300px;">
                                    <div class="row mb-3">
                                        <div class="col-md-3 text-center">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body p-2">
                                                    <h6 class="text-primary mb-1">Server 8001</h6>
                                                    <small class="text-muted" x-text="liveLogs.server_8001.length + ' logs'"></small>
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger me-1" x-text="liveLogs.server_8001.filter(l => l.level === 'ERROR').length + ' errors'"></span>
                                                        <span class="badge bg-warning" x-text="liveLogs.server_8001.filter(l => l.level === 'WARNING').length + ' warnings'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body p-2">
                                                    <h6 class="text-info mb-1">Server 8002</h6>
                                                    <small class="text-muted" x-text="liveLogs.server_8002.length + ' logs'"></small>
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger me-1" x-text="liveLogs.server_8002.filter(l => l.level === 'ERROR').length + ' errors'"></span>
                                                        <span class="badge bg-warning" x-text="liveLogs.server_8002.filter(l => l.level === 'WARNING').length + ' warnings'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body p-2">
                                                    <h6 class="text-success mb-1">System</h6>
                                                    <small class="text-muted" x-text="liveLogs.system.length + ' logs'"></small>
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger me-1" x-text="liveLogs.system.filter(l => l.level === 'ERROR').length + ' errors'"></span>
                                                        <span class="badge bg-warning" x-text="liveLogs.system.filter(l => l.level === 'WARNING').length + ' warnings'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="card bg-dark border-secondary">
                                                <div class="card-body p-2">
                                                    <h6 class="text-warning mb-1">Total</h6>
                                                    <small class="text-muted" x-text="liveLogs.all.length + ' logs'"></small>
                                                    <div class="mt-1">
                                                        <small class="text-muted" x-text="'Live streaming active'"></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="height: 200px; overflow-y: auto;">
                                        <!-- Server 8001 Logs -->
                                        <div class="mb-3">
                                            <h6 class="text-primary mb-2"><i class="bi bi-server me-2"></i>Server 8001</h6>
                                            <template x-for="log in liveLogs.server_8001">
                                                <p class="mb-1 small">
                                                    <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                    <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                    <span x-text="log.message || log.msg || 'No message'"></span>
                                                </p>
                                            </template>
                                        </div>
                                        
                                        <!-- Server 8002 Logs -->
                                        <div class="mb-3">
                                            <h6 class="text-info mb-2"><i class="bi bi-server me-2"></i>Server 8002</h6>
                                            <template x-for="log in liveLogs.server_8002">
                                                <p class="mb-1 small">
                                                    <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                    <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                    <span x-text="log.message || log.msg || 'No message'"></span>
                                                </p>
                                            </template>
                                        </div>
                                        
                                        <!-- System Logs -->
                                        <div class="mb-3">
                                            <h6 class="text-success mb-2"><i class="bi bi-gear me-2"></i>System</h6>
                                            <template x-for="log in liveLogs.system">
                                                <p class="mb-1 small">
                                                    <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                    <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                    <span x-text="log.message || log.msg || 'No message'"></span>
                                                </p>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Server 8001 Tab -->
                                <div x-show="liveFeedView === 'server_8001'" class="terminal" style="height: 300px;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="text-primary mb-0"><i class="bi bi-server me-2"></i>Server 8001 Logs</h6>
                                        <div>
                                            <span class="badge bg-success me-2">active</span>
                                            <small class="text-muted" x-text="liveLogs.server_8001.length + ' total logs'"></small>
                                        </div>
                                    </div>
                                    <div style="height: 240px; overflow-y: auto;">
                                        <template x-for="log in liveLogs.server_8001">
                                            <p class="mb-1 small">
                                                <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                <span x-text="log.message || log.msg || 'No message'"></span>
                                            </p>
                                        </template>
                                        <div x-show="!liveLogs.server_8001.length" class="text-center text-muted pt-5">
                                            <i class="bi bi-inbox fs-1"></i>
                                            <p>No logs available for Server 8001</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Server 8002 Tab -->
                                <div x-show="liveFeedView === 'server_8002'" class="terminal" style="height: 300px;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="text-info mb-0"><i class="bi bi-server me-2"></i>Server 8002 Logs</h6>
                                        <div>
                                            <span class="badge bg-success me-2">active</span>
                                            <small class="text-muted" x-text="liveLogs.server_8002.length + ' total logs'"></small>
                                        </div>
                                    </div>
                                    <div style="height: 240px; overflow-y: auto;">
                                        <template x-for="log in liveLogs.server_8002">
                                            <p class="mb-1 small">
                                                <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                <span x-text="log.message || log.msg || 'No message'"></span>
                                            </p>
                                        </template>
                                        <div x-show="!liveLogs.server_8002.length" class="text-center text-muted pt-5">
                                            <i class="bi bi-inbox fs-1"></i>
                                            <p>No logs available for Server 8002</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Tab -->
                                <div x-show="liveFeedView === 'system'" class="terminal" style="height: 300px;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="text-success mb-0"><i class="bi bi-gear me-2"></i>System Logs</h6>
                                        <div>
                                            <small class="text-muted" x-text="liveLogs.system.length + ' total logs'"></small>
                                        </div>
                                    </div>
                                    <div style="height: 240px; overflow-y: auto;">
                                        <template x-for="log in liveLogs.system">
                                            <p class="mb-1 small">
                                                <span x-text="formatTime(log.timestamp) + ' '"></span>
                                                <span :class="getEventClass(log.level)" x-text="'[' + (log.level || 'INFO') + '] '"></span>
                                                <span x-text="log.message || log.msg || 'No message'"></span>
                                            </p>
                                        </template>
                                        <div x-show="!liveLogs.system.length" class="text-center text-muted pt-5">
                                            <i class="bi bi-inbox fs-1"></i>
                                            <p>No system logs available</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MISSIONS TAB (OPERATIONS DECK) -->
                <div x-show="activeTab === 'missions'" class="fade-in" style="width: 100%;">
                    <div class="row g-4">
                        <!-- Deploy Mission -->
                        <div class="col-lg-6">
                            <div class="main__cards-container h-100">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="me-3"><div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;"><i class="bi bi-rocket-takeoff text-white fs-5"></i></div></div>
                                    <div><h2 class="ss-heading mb-1">Deploy New Mission</h2><p class="text-muted small mb-0">Create and launch new AI missions</p></div>
                                </div>
                                <div>
                                    <label class="form-label text-light small mb-2">Mission Title</label>
                                    <input type="text" class="form-control mb-3" x-model="newMission.title" placeholder="Enter mission title (optional)">
                                    <label class="form-label text-light small mb-2">Mission Objective</label>
                                    <textarea class="form-control" rows="6" x-model="newMission.objective" placeholder="Describe your mission objective in detail..."></textarea>
                                    <button class="btn w-100 mt-3 header__pro" @click="deployMission()" :disabled="deploying" style="height: 56px; font-size: 1.1rem;"><i class="bi bi-rocket-takeoff me-2"></i><span x-text="deploying ? 'DEPLOYING...' : 'DEPLOY MISSION'"></span></button>
                                </div>
                            </div>
                        </div>
                        <!-- Active Missions -->
                        <div class="col-lg-6">
                            <div class="main__cards-container h-100">
                                <h2 class="ss-heading">Active Missions</h2>
                                <div style="height: 300px; overflow-y: auto;">
                                    <template x-for="mission in activeMissions" :key="mission.id">
                                        <div class="card mb-2" style="background: hsl(270, 50%, 8%);">
                                            <div class="card-body p-3">
                                                <h6 class="mb-1" x-text="mission.title"></h6>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted" x-text="mission.mission_id_str"></small>
                                                    <span class="badge" :class="getStatusClass(mission.status)" x-text="mission.status"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="activeMissions.length === 0" class="text-center text-muted pt-5"><i class="bi bi-inbox fs-1"></i><p>No active missions.</p></div>
                                </div>
                            </div>
                        </div>
                        <!-- Mission History -->
                        <div class="col-lg-12">
                            <div class="main__cards-container">
                                <h2 class="ss-heading">Mission History</h2>
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table style="background: hsl(270, 50%, 8%); color: #f8f9fa; border-collapse: collapse; width: 100%;">
                                    <thead>
                                            <tr style="background: hsl(270, 50%, 12%);">
                                                <th style="color: #f8f9fa; border: 1px solid hsl(270, 50%, 15%); padding: 12px; text-align: left;">ID</th>
                                                <th style="color: #f8f9fa; border: 1px solid hsl(270, 50%, 15%); padding: 12px; text-align: left;">Title</th>
                                                <th style="color: #f8f9fa; border: 1px solid hsl(270, 50%, 15%); padding: 12px; text-align: left;">Status</th>
                                                <th style="color: #f8f9fa; border: 1px solid hsl(270, 50%, 15%); padding: 12px; text-align: left;">Actions</th>
                                            </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="mission in missions" :key="mission.id">
                                                <tr style="background: hsl(270, 50%, 8%); border: 1px solid hsl(270, 50%, 15%);">
                                                    <td style="border: 1px solid hsl(270, 50%, 15%); padding: 12px;"><code class="text-primary" x-text="mission.mission_id_str.split('_')[1]"></code></td>
                                                    <td style="border: 1px solid hsl(270, 50%, 15%); padding: 12px;"><div class="fw-semibold" x-text="mission.title"></div><small class="text-muted" x-text="mission.prompt?.substring(0, 50) + '...'"></small></td>
                                                    <td style="border: 1px solid hsl(270, 50%, 15%); padding: 12px;"><span class="badge" :class="getStatusClass(mission.status)" x-text="mission.status"></span></td>
                                                    <td style="border: 1px solid hsl(270, 50%, 15%); padding: 12px;"><button class="btn btn-sm btn-outline-primary" @click="viewMission(mission)" title="View Details"><i class="bi bi-eye"></i></button></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal fade" id="missionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="background: hsl(270, 50%, 8%); border: 1px solid hsl(270, 50%, 15%);">
                <div class="modal-header" style="background: hsl(270, 50%, 12%); border-bottom: 1px solid hsl(270, 50%, 15%);">
                    <h5 class="modal-title ss-heading" style="color: #f8f9fa;"><i class="bi bi-robot me-2"></i> Mission Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" x-show="selectedMission" style="color: #f8f9fa;">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card" style="background: hsl(270, 50%, 8%); border: 1px solid hsl(270, 50%, 15%);">
                                <div class="card-header" style="background: hsl(270, 50%, 12%); border-bottom: 1px solid hsl(270, 50%, 15%); color: #f8f9fa;"><h6 class="card-title mb-0">Overview</h6></div>
                                <div class="card-body" style="color: #f8f9fa;">
                                    <p><strong>Mission ID:</strong> <span x-text="selectedMission?.mission_id_str || selectedMission?.id || 'N/A'"></span></p>
                                    <p><strong>Title:</strong> <span x-text="selectedMission?.title || 'N/A'"></span></p>
                                    <p><strong>Agent Type:</strong> <span class="badge bg-primary" x-text="selectedMission?.agent_type || 'N/A'"></span></p>
                                    <p><strong>Status:</strong> <span class="badge" :class="'bg-' + getStatusClass(selectedMission?.status || '')" x-text="selectedMission?.status || 'N/A'"></span></p>
                                    <p><strong>Created:</strong> <span x-text="formatDate(selectedMission?.created_at)"></span></p>
                                    <p x-show="selectedMission?.execution_time"><strong>Execution Time:</strong> <span x-text="(selectedMission?.execution_time || 0) + ' seconds'"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="card" style="background: hsl(270, 50%, 8%); border: 1px solid hsl(270, 50%, 15%);">
                                <div class="card-header" style="background: hsl(270, 50%, 12%); border-bottom: 1px solid hsl(270, 50%, 15%); color: #f8f9fa;"><h6 class="card-title mb-0">Prompt</h6></div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto; color: #f8f9fa;">
                                    <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; color: #f8f9fa;" x-text="selectedMission?.prompt || 'No prompt available'"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="background: hsl(270, 50%, 8%); border: 1px solid hsl(270, 50%, 15%);">
                        <div class="card-header" style="background: hsl(270, 50%, 12%); border-bottom: 1px solid hsl(270, 50%, 15%); color: #f8f9fa;"><h6 class="card-title mb-0">Result & Live Feed</h6></div>
                        <div class="card-body" style="color: #f8f9fa;">
                            <div x-show="selectedMission?.result"><h6 class="mb-2 ss-heading">Final Result:</h6><div class="p-3 rounded mb-3 terminal" style="background: var(--sentinel-black-primary);"><pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; color: #f8f9fa;" x-text="JSON.stringify(selectedMission?.result || {}, null, 2)"></pre></div></div>
                            <div x-show="selectedMission?.updates"><h6 class="mb-2 ss-heading">Updates:</h6><div class="p-3 rounded terminal" style="background: var(--sentinel-black-primary); max-height: 250px; color: #f8f9fa;"><template x-for="update in selectedMission?.updates || []"><p class="mb-1 small"><span x-text="formatTime(update.timestamp) + ': '"></span><span x-text="update.message"></span></p></template></div></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: hsl(270, 50%, 12%); border-top: 1px solid hsl(270, 50%, 15%);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary header__pro" @click="refreshMissionDetails()"><i class="bi bi-arrow-clockwise me-2"></i> Refresh</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"><div id="toast-container"></div></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sentinelApp() {
            return {
                activeTab: 'dashboard',
                deploying: false,
                newMission: { title: '', objective: '' },
                missions: [],
                activeMissions: [],
                selectedMission: null,
                serviceStatus: { overall_status: 'loading' },
                liveEvents: [],
                observabilityView: 'overview',
                observability: {
                    weave: { status: 'loading', active_traces: 0, success_rate: 0, avg_response_ms: 0 },
                    wandb: { status: 'loading', active_runs: 0, best_accuracy: 0, avg_loss: 0 },
                    sentry: { status: 'loading', active_issues: 0, error_rate_percent: 0, uptime_percent: 0 }
                },
                liveFeedView: 'overview', // Added for live event feed tabs
                liveLogs: {
                    all: [],
                    server_8001: [],
                    server_8002: [],
                    system: []
                },

                init() {
                    this.hideLoadingScreen();
                    this.loadInitialData();
                    this.startLogStreaming();
                },
                
                async loadInitialData() {
                    // Load historical missions once on startup
                    try {
                        const response = await fetch('/missions');
                        if (response.ok) {
                            this.missions = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading initial missions:', error);
                    }
                },
                
                setActiveTab(tab) { this.activeTab = tab; },

                async deployMission() {
                    if (!this.newMission.objective.trim()) { 
                        this.showToast('Please enter a mission objective', 'warning');
                        return; 
                    }
                    
                    this.deploying = true;
                    try {
                        const response = await fetch('/api/missions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                prompt: this.newMission.objective, 
                                title: this.newMission.title || 'New Mission',
                                agent_type: 'developer'
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                        this.showToast('Mission deployed successfully!', 'success');
                            this.newMission = { title: '', objective: '' };
                        this.loadMissions();
                        } else {
                            this.showToast('Failed to deploy mission', 'error');
                        }
                    } catch (error) {
                        console.error('Error deploying mission:', error);
                        this.showToast('Error deploying mission', 'error');
                    } finally {
                        this.deploying = false;
                    }
                },

                async loadMissions() {
                    try {
                        const response = await fetch('/missions');
                        if (response.ok) { 
                            this.missions = await response.json();
                            this.activeMissions = this.missions.filter(m => ['PLANNING', 'EXECUTING'].includes(m.status.toUpperCase()));
                        }
                    } catch (error) { console.error('Error loading missions:', error); }
                },
                
                async updateServiceStatus() {
                    try {
                        const response = await fetch('/service-status');
                        if (response.ok) {
                            this.serviceStatus = await response.json();
                        }
                    } catch (error) { console.error('Error updating service status:', error); }
                },

                async updateObservabilityOverview() {
                    try {
                        const response = await fetch('/api/observability/overview');
                        if (response.ok) { 
                            const data = await response.json();
                            this.observability = data;
                        } else {
                            this.observability.weave.status = "Error";
                            this.observability.wandb.status = "Error";
                            this.observability.sentry.status = "Error";
                        }
                    } catch(e) { 
                        console.error('Failed to load observability overview:', e);
                        this.observability.weave.status = "Error";
                        this.observability.wandb.status = "Error";
                        this.observability.sentry.status = "Error";
                    }
                },
                
                async updateLiveEvents() {
                    try {
                        const response = await fetch('/api/events/live');
                        if (response.ok) { this.liveEvents = await response.json(); }
                    } catch(e) { console.error('Failed to load live events'); }
                },



                formatTime(dateString) { 
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return 'Invalid Date';
                        return date.toLocaleTimeString();
                    } catch (e) {
                        return 'Invalid Date';
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return 'Invalid Date';
                        return date.toLocaleString();
                    } catch (e) {
                        return 'Invalid Date';
                    }
                },

                getStatusClass(status) {
                    const statusLower = status.toLowerCase();
                    if (statusLower === 'completed') return 'bg-success';
                    if (statusLower === 'executing') return 'bg-warning';
                    if (statusLower === 'failed') return 'bg-danger';
                    if (statusLower === 'planning') return 'bg-info';
                    return 'bg-secondary';
                },
                
                getEventClass(level) {
                    if (!level) return 'text-info';
                    const levelUpper = level.toUpperCase();
                    if (levelUpper === 'ERROR') return 'text-danger';
                    if (levelUpper === 'WARNING') return 'text-warning';
                    return 'text-info';
                },

                async viewMission(mission) {
                    this.selectedMission = mission;
                            const modal = new bootstrap.Modal(document.getElementById('missionDetailsModal'));
                            modal.show();
                },

                hideLoadingScreen() {
                    setTimeout(() => {
                        const screen = document.getElementById('loading-screen');
                        if(screen) {
                           screen.style.opacity = '0';
                           setTimeout(() => screen.style.display = 'none', 500);
                        }
                    }, 500);
                },

                showToast(message, type = 'info') {
                    const toastContainer = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
                    toast.setAttribute('role', 'alert');
                    toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    `;
                    toastContainer.appendChild(toast);
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.show();
                    setTimeout(() => {
                        toast.remove();
                    }, 5000);
                },

                refreshAllData() {
                    this.fetchAllData();
                    this.showToast('Data refreshed', 'info');
                },

                startLogStreaming() {
                    console.log("Connecting to real-time log stream...");
                    const eventSource = new EventSource('/api/events/stream');

                    eventSource.onmessage = (event) => {
                        try {
                            const logEntry = JSON.parse(event.data);
                            if (logEntry.type === 'keepalive') return;

                            // Add to the 'all' logs buffer
                            this.liveLogs.all.unshift(logEntry);
                            if (this.liveLogs.all.length > 200) this.liveLogs.all.pop();
                            
                            // Categorize by server port
                            const serverPort = logEntry.server_port || '8001';
                            if (serverPort === '8001') {
                                this.liveLogs.server_8001.unshift(logEntry);
                                if (this.liveLogs.server_8001.length > 50) this.liveLogs.server_8001.pop();
                            } else if (serverPort === '8002') {
                                this.liveLogs.server_8002.unshift(logEntry);
                                if (this.liveLogs.server_8002.length > 50) this.liveLogs.server_8002.pop();
                            } else {
                                this.liveLogs.system.unshift(logEntry);
                                if (this.liveLogs.system.length > 50) this.liveLogs.system.pop();
                            }

                        } catch (e) {
                            console.error('Error parsing log stream:', e);
                        }
                    };

                    eventSource.onerror = (error) => {
                        console.error('Log streaming connection error. Reconnecting in 5s...', error);
                        eventSource.close();
                        setTimeout(() => this.startLogStreaming(), 5000);
                    };
                },


            }
        }
    </script>
</body>
</html>